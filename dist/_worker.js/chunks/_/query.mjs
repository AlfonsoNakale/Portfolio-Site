import{Buffer as e}from"node:buffer";import{f as r,h as t}from"./nitro.mjs";import"node:timers";import"node:events";import"node:process";import"cloudflare:workers";function regExpReviver(e,r){const t="string"==typeof r&&r.match(/^--([A-Z]+) (.+)$/)||[];if("REGEX"===t[1]){const e=t[2]?.match(/\/(.*)\/([dgimsuy]*)$/);return e?.[1]?new RegExp(e[1],e[2]||""):r}return r}const parseJSONQueryParams=e=>{try{return r=e,JSON.parse(r,regExpReviver)}catch{throw t({statusCode:400,message:"Invalid _params query"})}var r},decodeQueryParams=r=>(r=(r=(r=r.replace(/\//g,"")).replace(/-/g,"+").replace(/_/g,"/")).padEnd(r.length+(4-r.length%4)%4,"="),parseJSONQueryParams(void 0!==e?e.from(r,"base64").toString():atob(r))),o={},getContentQuery=e=>{const{params:t}=e.context.params||{};if(t)return decodeQueryParams(t.replace(/.json$/,""));const n=e.context.params?.qid?.replace(/.json$/,""),s=r(e)||{};if(n&&s._params)return o[n]=parseJSONQueryParams(decodeURIComponent(s._params)),o[n]?.where&&!Array.isArray(o[n]?.where)&&(o[n].where=[o[n].where]),o[n];if(n&&o[n])return o[n];if(s._params)return parseJSONQueryParams(decodeURIComponent(s._params));"string"==typeof s.only&&s.only.includes(",")&&(s.only=s.only.split(",").map(e=>e.trim())),"string"==typeof s.without&&s.without.includes(",")&&(s.without=s.without.split(",").map(e=>e.trim()));const a=s.where||{};for(const e of["draft","partial","empty"])s[e]&&["true","false"].includes(s[e])&&(a[e]="true"===s[e],delete s[e]);s.sort&&(s.sort=String(s.sort).split(",").map(e=>{const[r,t]=e.split(":");return[r,Number.parseInt(t||"0",10)]}));const i=["partial","draft","only","without","where","sort","limit","skip"];for(const e of Object.keys(s))i.includes(e)||(s.where=s.where||{},s.where[e]=s[e]);return Object.keys(a).length>0?s.where=[a]:delete s.where,s};export{decodeQueryParams,getContentQuery};
//# sourceMappingURL=query.mjs.map
