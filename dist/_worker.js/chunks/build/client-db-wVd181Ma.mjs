import{I as t,a0 as e,N as r,ab as n,ac as i,F as a}from"../_/nitro.mjs";import{c as o,b as s,d as l,o as c,g as u,f as d,h as f,i as p,k as g}from"./query-D_xpVYMB.mjs";import{a as h,b as m}from"./server.mjs";import{u as v}from"./preview-DaGHZvIK.mjs";import"node:buffer";import"node:timers";import"node:events";import"node:process";import"cloudflare:workers";import"../_/index2.mjs";import"../routes/renderer.mjs";import"../_/shared.esm-bundler.mjs";function createMatch(t={}){const e=function(t,e={}){return{$match:(e,r)=>t(e,r),$eq:(t,e)=>e instanceof RegExp?e.test(t):t===e,$ne:(t,e)=>e instanceof RegExp?!e.test(t):t!==e,$not:(e,r)=>!t(e,r),$and:(e,r)=>(g(r,"$and requires an array as condition"),r.every(r=>t(e,r))),$or:(e,r)=>(g(r,"$or requires an array as condition"),r.some(r=>t(e,r))),$in:(e,r)=>s(r).some(r=>Array.isArray(e)?t(e,{$contains:r}):t(e,r)),$contains:(t,e)=>(t=Array.isArray(t)?t:String(t),s(e).every(e=>t.includes(e))),$icontains:(t,e)=>{if("string"!=typeof e)throw new TypeError("$icontains requires a string, use $contains instead");return t=String(t).toLocaleLowerCase(),s(e).every(e=>t.includes(e.toLocaleLowerCase()))},$containsAny:(t,e)=>(g(e,"$containsAny requires an array as condition"),t=Array.isArray(t)?t:String(t),e.some(e=>t.includes(e))),$exists:(t,e)=>e?void 0!==t:void 0===t,$type:(t,e)=>typeof t===String(e),$regex:(t,e)=>{if(!(e instanceof RegExp)){const t=String(e).match(/\/(.*)\/([dgimsuy]*)$/);e=(null==t?void 0:t[1])?new RegExp(t[1],t[2]||""):new RegExp(e)}return e.test(String(t||""))},$lt:(t,e)=>t<e,$lte:(t,e)=>t<=e,$gt:(t,e)=>t>e,$gte:(t,e)=>t>=e,...e||{}}}(match,t.operators);function match(t,r){return"object"!=typeof r||r instanceof RegExp?e.$eq(t,r):Object.keys(r||{}).every(n=>{const i=r[n];if(n.startsWith("$")&&e[n]){const r=e[n];return"function"==typeof r&&r(t,i)}return match(u(t,n),i)})}return match}function createPipelineFetcher(t){const e=createMatch(),r=[(t,r)=>{const n=t.result.filter(t=>s(r.where).every(r=>e(t,r)));return{...t,result:n,total:n.length}},(t,e)=>s(e.sort).forEach(e=>d(t.result,e)),function(t,r,n){var i;if(r.surround){let a=((t,{query:r,before:n,after:i})=>{const a="string"==typeof r?{_path:r}:r,o=t.findIndex(t=>e(t,a));n=null!=n?n:1,i=null!=i?i:1;const s=new Array(n+i).fill(null,0);return-1===o?s:s.map((e,r)=>t[o-n+r+Number(r>=n)]||null)})(1===(null==(i=t.result)?void 0:i.length)?n:t.result,r.surround);a=l(f(r.without))(a),a=l(p(r.only))(a),t.surround=a}return t}],n=[(t,e)=>{if(e.skip)return{...t,result:t.result.slice(e.skip),skip:e.skip}},(t,e)=>{if(e.limit)return{...t,result:t.result.slice(0,e.limit),limit:e.limit}},function(t,e,r){var n,i,o;if(e.dirConfig){const s=(null==(n=t.result[0])?void 0:n._path)||(null==(o=null==(i=e.where)?void 0:i.find(t=>t._path))?void 0:o._path);if("string"==typeof s){const e=r.find(t=>t._path===a(s,"_dir"));e&&(t.dirConfig={_path:e._path,...f(["_"])(e)})}}return t},(t,e)=>({...t,result:l(f(e.without))(t.result)}),(t,e)=>({...t,result:l(p(e.only))(t.result)})];return async e=>{const i=await t(),a=e.params(),o={result:i,limit:0,skip:0,total:i.length},s=r.reduce((t,e)=>e(t,a,i)||t,o);if(a.count)return{result:s.result.length};const l=n.reduce((t,e)=>e(t,a,i)||t,s);return a.first?{...c(["skip","limit","total"])(l),result:l.result[0]}:l}}function createPipelineFetcherLegacy(t){const e=createPipelineFetcher(t);return async t=>{var r;t.params().first&&t.withDirConfig();const n=t.params(),i=await e(t);return n.surround?null==i?void 0:i.surround:((null==i?void 0:i.dirConfig)&&(i.result={_path:null==(r=i.dirConfig)?void 0:r._path,...i.result,_dir:i.dirConfig}),null==i?void 0:i.result)}}function createNav(t,e){const{navigation:n}=h().public.content;if(!1===n)return[];const pickNavigationFields=t=>{return{...(r=["title",...n.fields],t=>(t=t||{},r&&r.length?r.filter(e=>void 0!==t[e]).reduce((e,r)=>Object.assign(e,{[r]:t[r]}),{}):t))(t),...(e=null==t?void 0:t.navigation,"[object Object]"===Object.prototype.toString.call(e)?t.navigation:{})};var e,r};return sortAndClear(t.sort((t,e)=>t._path.localeCompare(e._path)).reduce((t,n)=>{var i;const a=n._path.substring(1).split("/"),o=n._id.split(":").slice(1),s=!!(null==(i=o[o.length-1])?void 0:i.match(/([1-9][0-9]*\.)?index.md/g)),getNavItem=t=>({title:t.title,_path:t._path,_file:t._file,children:[],...pickNavigationFields(t),...t._draft?{_draft:!0}:{}}),l=getNavItem(n);if(s){const r=e[l._path];if(void 0!==(null==r?void 0:r.navigation)&&!(null==r?void 0:r.navigation))return t;if("/"!==n._path){const t=getNavItem(n);l.children.push(t)}r&&Object.assign(l,pickNavigationFields(r))}if(1===a.length)return t.push(l),t;return a.slice(0,-1).reduce((t,i,o)=>{const s="/"+a.slice(0,o+1).join("/"),l=e[s];if(void 0!==(null==l?void 0:l.navigation)&&!l.navigation)return[];let c=t.find(t=>t._path===s);var u;return c||(c={title:(u=i,u.split(/[\s-]/g).map(r).join(" ")),_path:s,_file:n._file,children:[],...l&&pickNavigationFields(l)},t.push(c)),c.children},t).push(l),t},[]))}const y=new Intl.Collator(void 0,{numeric:!0,sensitivity:"base"});function sortAndClear(t){var e;t.forEach(t=>{t._file=t._file.split(".").slice(0,-1).join(".")});const r=t.sort((t,e)=>y.compare(t._file,e._file));for(const t of r)(null==(e=t.children)?void 0:e.length)?sortAndClear(t.children):delete t.children,delete t._file;return t}const _=t(n({driver:i()}),"@content");function createDB(t){async function getItems(){const e=new Set(await t.getKeys("cache:")),r=v().getPreviewToken();if(r){const n=await t.getItem(`${r}$`).then(t=>t||{});if(Array.isArray(n.ignoreSources)){const t=n.ignoreSources.map(t=>`cache:${t.trim()}:`);for(const r of e)t.some(t=>r.startsWith(t))&&e.delete(r)}const i=await t.getKeys(`${r}:`),a=await Promise.all(i.map(e=>t.getItem(e)));for(const t of a)e.delete(`cache:${t._id}`),t.__deleted||e.add(`${r}:${t._id}`)}return await Promise.all(Array.from(e).map(e=>t.getItem(e)))}return{storage:t,fetch:createPipelineFetcherLegacy(getItems),query:t=>o(createPipelineFetcherLegacy(getItems),{initialParams:t,legacy:!0})}}let w=null,$=null;async function useContentDatabase(){return $?await $:w||($=async function(){const t=m(),{content:r}=h().public,n=createDB(_),i=await n.storage.getItem("integrity");if(r.integrity!==+(i||0)){const{contents:t,navigation:i}=await $fetch((a=r.integrity?`cache.${r.integrity}.json`:"cache.json",e(a,h().public.content.api.baseURL)));await Promise.all(t.map(t=>n.storage.setItem(`cache:${t._id}`,t))),await n.storage.setItem("navigation",i),await n.storage.setItem("integrity",r.integrity)}var a;return await t.callHook("content:storage",n.storage),n}(),w=await $),w}async function generateNavigation(t){const e=await useContentDatabase();if(!v().getPreviewToken()&&0===Object.keys(t||{}).length)return e.storage.getItem("navigation");return createNav(await e.query(t).where({_partial:!1,navigation:{$ne:!1}}).find(),(await e.query().where({_path:/\/_dir$/i,_partial:!0}).find()).reduce((t,e)=>{var r;"dir"===(null==(r=e.title)?void 0:r.toLowerCase())&&(e.title=void 0);return t[e._path.split("/").slice(0,-1).join("/")||"/"]={...e,...e.body},t},{}))}export{_ as contentStorage,createDB,generateNavigation,useContentDatabase};
//# sourceMappingURL=client-db-wVd181Ma.mjs.map
